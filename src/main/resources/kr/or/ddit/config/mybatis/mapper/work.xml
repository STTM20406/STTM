<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="work">

<!-- ******************work**************** -->
	<update id="updateWork" parameterType="workVo">
		UPDATE	WORK
		SET		WRK_LST_ID = #{wrk_lst_id}
				,WRK_PR_ID = #{wrk_pr_id}
				,USER_EMAIL = #{user_email}
				,WRK_NM = #{wrk_nm}
				,WRK_GRADE = #{wrk_grade}
				,WRK_COLOR_CD = #{wrk_color_cd}
				,WRK_START_DT = #{wrk_start_dt}
				,WRK_END_DT = #{wrk_end_dt}
				,WRK_CMP_DT = #{wrk_cmp_dt, jdbcType=DATE}
				,WRK_CMP_FL = #{wrk_cmp_fl}
				,WRK_DEL_FL = #{wrk_del_fl}
		WHERE	WRK_ID = #{wrk_id}
	</update>
	
	<!-- 업무리스트에 해당하는 업무 조회-->
	<select id="getWork" parameterType="int" resultType="workVo">
		SELECT  DISTINCT    C.PRJ_ID
						,  D.PRJ_NM
						,  A.WRK_LST_ID  
					        ,  C.WRK_LST_NM 
					        ,  A.WRK_ID
					        ,  A.WRK_NM
					        ,  C.DEL_FL
					        ,  A.USER_EMAIL
					        ,  B.USER_NM
					        ,  A.WRK_RV_ID
					        ,  A.WRK_PR_ID
					        ,  A.WRK_DT
					        ,  A.WRK_GRADE
					        ,  A.WRK_COLOR_CD
					        ,  A.WRK_START_DT
					        ,  A.WRK_END_DT
					        ,  A.WRK_CMP_DT
					        ,  A.WRK_CMP_FL
					        ,  A.WRK_DEL_FL
   		FROM    			WORK A, USERS B, WORK_LIST C, PROJECT D
      		WHERE			A.WRK_LST_ID = #{wrk_lst_id}
     		AND				A.USER_EMAIL = B.USER_EMAIL
      		AND				A.WRK_LST_ID = C.WRK_LST_ID
      		AND				C.PRJ_ID = D.PRJ_ID
      		AND     			C.DEL_FL = 'N'
      		AND     			A.WRK_DEL_FL = 'N'
	</select>
	
	<!-- 업무 카운트 > 다시 해야함 -->
	<select id="getWorkListCnt" parameterType="workVo" resultType="workVo">
		SELECT  	COUNT(*) wrkListCnt, A.WRK_LST_ID
		FROM    	WORK A, WORK_LIST B
		WHERE   	A.WRK_LST_ID = B.WRK_LST_ID
		AND     	A.WRK_LST_ID = #{wrk_lst_id}
		AND     	A.WRK_CMP_FL = #{wrk_cmp_fl} GROUP BY A.WRK_LST_ID
	</select>

	<!--  업무 생성 -->
	<insert id="insertWork" parameterType="workVo">
		INSERT INTO WORK (WRK_ID, WRK_LST_ID, WRK_PR_ID, USER_EMAIL, WRK_NM, WRK_DT, WRK_GRADE, WRK_CMP_FL, WRK_DEL_FL)
		VALUES(WRK_SEQ.NEXTVAL, #{wrk_lst_id}, WRK_SEQ.NEXTVAL, #{user_email}, #{wrk_nm}, SYSDATE, 'C', 'N', 'N')
	</insert>
	
	
	<!-- 업무 이동시 업무 리스트 아이디 업데이트 -->
	<update id="updateWorkID" parameterType="workVo">
		UPDATE WORK SET WRK_LST_ID = #{wrk_lst_id} WHERE WRK_ID = #{wrk_id}
	</update>
	
	
	<!-- 업무 아이디로 업무 정보 얻어오기 -->
	<select id="getWorkInfo" parameterType="int" resultType="workVo">
		SELECT A.*, B.USER_NM FROM WORK A, USERS B WHERE WRK_ID = #{wrk_id} AND A.USER_EMAIL = B.USER_EMAIL
	</select>
	
	<!-- 업무 완료 체크시 완료 플래그 업데이트 -->
	<update id="updateWorkCmp" parameterType="workVo">
		UPDATE WORK SET 	WRK_CMP_FL = #{wrk_cmp_fl},
							<choose>
								<when test="wrk_cmp_dt != null">
									WRK_CMP_DT = #{wrk_cmp_dt}
								</when>
								<otherwise>
									WRK_CMP_DT = SYSDATE
								</otherwise>
							</choose>
		WHERE WRK_ID = #{wrk_id}
	</update>
	
	
	<!-- 업무 전체 업데이트 -->
	<update id="updateAllWork" parameterType="workVo">
		UPDATE WORK SET 
				<if test="wrk_nm != null">
				 WRK_NM = #{wrk_nm}
				</if>
				<if test="wrk_grade != null">
		                , WRK_GRADE = #{wrk_grade}
		                </if>
		                <if test="wrk_start_dt != null">
		                , WRK_START_DT = #{wrk_start_dt}
		                </if>
		                <if test="wrk_end_dt != null">
		                , WRK_END_DT = #{wrk_end_dt}
		                </if>
		WHERE WRK_ID = #{wrk_id}
	</update>
	
	
	<!-- 업무 라벨 컬러 업데이트 -->
	<update id="updateWorkColor" parameterType="workVo">
		UPDATE WORK SET 
						<choose>
							<when test="wrk_color_cd != null">
								WRK_COLOR_CD = #{wrk_color_cd}
							</when>
							<otherwise>
								WRK_COLOR_CD = NULL
							</otherwise>
						</choose>
	 	WHERE WRK_ID = #{wrk_id}
	</update>




<!-- ******************work_al_mem**************** -->







<!-- ******************work_comment**************** -->
	<!-- 업무코멘트 등록 -->
	<insert id="commInsert" parameterType="work_commentVo">
		insert into work_comment values(wrk_comm_seq.nextval,#{prj_id},#{user_email},#{wrk_id},#{comm_content},sysdate,'N')
	</insert>
	
	<!-- 업무코멘트 삭제 -->
	<update id="commDelete" parameterType="work_commentVo">
		update work_comment 
		set del_fl='Y' 
		where comm_id=#{comm_id} 
		and prj_id =#{prj_id} 
	</update>
	
	<!-- 업무코멘트 수정 -->
	<update id="commUpdate" parameterType="work_commentVo">
		update work_comment 
		set comm_content=#{comm_content}
		where comm_id=#{comm_id} 
		and prj_id =#{prj_id} 
	</update>
	
	<!-- 업무코멘트 조회 -->
	<select id="commList" parameterType="pageVo" resultType="work_commentVo">
		<![CDATA[
	select *
    from
	(select a.*, ROW_NUMBER() OVER(order by comm_id desc) rn
    from
    (select * 
		from work_comment 
		where wrk_id = #{wrk_id}
		and prj_id = #{prj_id}
		and del_fl = 'N'
		order by comm_id desc) a)
		where rn >=(#{page}-1)*#{pageSize} + 1 and rn <=#{page}*#{pageSize}
	]]>
	</select>

	<select id="commCnt" parameterType="pageVo" resultType="int">
		select count(*) 
		from work_comment 
		where wrk_id = #{wrk_id}
		and prj_id = #{prj_id}
	</select>
<!-- ******************work_list**************** -->
	
	<!-- 프로젝트 아이디로  업무 리스트만 조회 -->
	<select id="workList" parameterType="int" resultType="workVo">
		SELECT 	  A.WRK_LST_ID
		     		, A.PRJ_ID
		     		, A.WRK_LST_NM
		     		, A.WRK_LST_DT
		     		, A.DEL_FL 
		FROM   	  WORK_LIST A 
		WHERE  	  PRJ_ID = #{prj_id}
		AND    	  DEL_FL = 'N'
	</select>
	
	<!--  업무리스트 생성 -->
	<insert id="insertWorkList" parameterType="work_listVo">
		INSERT INTO WORK_LIST VALUES(WRK_LST_SEQ.NEXTVAL, #{prj_id}, #{wrk_lst_nm}, SYSDATE, 'N')
	</insert>
	
	<!--  업무리스트 이름 수정 -->
	<update id="updateWorkList" parameterType="work_listVo">
		UPDATE WORK_LIST SET WRK_LST_NM = #{wrk_lst_nm} WHERE WRK_LST_ID = #{wrk_lst_id}
	</update>
	
	<!--  업무리스트 삭제 (하위 업무가 없는것만 삭제) -->
	<update id="deleteWorkList" parameterType="int">
		DELETE FROM WORK_LIST WHERE WRK_LST_ID = #{wrk_lst_id}
<!-- 		UPDATE WORK_LIST SET DEL_FL = 'Y' WHERE WRK_LST_ID = #{wrk_lst_id} -->
	</update>
	
	<!-- 업무 리스트 페이지 리스트 조회 -->
	<!-- pageVo int page, int pageSize -->
	<select id="timerWorkListPagingList" parameterType="map" resultType="work_listVo">
		<![CDATA[
	    select *
		from
		    (select a.*, rownum rn
		         from
		            (SELECT  DISTINCT A.WRK_ID
		               ,  A.USER_EMAIL
		               ,  C.WRK_LST_NM
		               ,  C.PRJ_ID
		               ,  B.USER_NM
		               ,  D.PRJ_NM
		               ,  A.WRK_LST_ID
		               ,  A.WRK_RV_ID
		               ,  A.WRK_PR_ID
		               ,  A.WRK_NM
		               ,  A.WRK_DT
		               ,  A.WRK_GRADE
		               ,  A.WRK_COLOR_CD
		               ,  A.WRK_START_DT
		               ,  A.WRK_END_DT
		               ,  A.WRK_CMP_DT
		               ,  A.WRK_CMP_FL
		               ,  A.WRK_DEL_FL
		      FROM    WORK A, USERS B, WORK_LIST C, PROJECT D
		      WHERE   A.user_email = #{user_email,jdbcType=VARCHAR}
		      AND     A.USER_EMAIL = B.USER_EMAIL
		      AND     A.WRK_LST_ID = C.WRK_LST_ID
		      AND     C.PRJ_ID = D.PRJ_ID
		      AND     A.WRK_DEL_FL = 'N') a )
		where rn >=(#{page}-1)*#{pageSize} + 1 and rn <=#{page}*#{pageSize}
		]]>
	</select>
	
	<!-- 업무 리스트 전체수 조회 -->
	<select id="timerWorkListCnt" parameterType="map" resultType="int">
		select count(*)
		from
		    (select a.*
		         from
		            (SELECT  DISTINCT A.WRK_ID
		               ,  A.USER_EMAIL
		               ,  C.WRK_LST_NM
		               ,  C.PRJ_ID
		               ,  B.USER_NM
		               ,  D.PRJ_NM
		               ,  A.WRK_LST_ID
		               ,  A.WRK_RV_ID
		               ,  A.WRK_PR_ID
		               ,  A.WRK_NM
		               ,  A.WRK_DT
		               ,  A.WRK_GRADE
		               ,  A.WRK_COLOR_CD
		               ,  A.WRK_START_DT
		               ,  A.WRK_END_DT
		               ,  A.WRK_CMP_DT
		               ,  A.WRK_CMP_FL
		               ,  A.WRK_DEL_FL
		      FROM    WORK A, USERS B, WORK_LIST C, PROJECT D
		      WHERE   A.user_email = #{user_email}
		      AND     A.USER_EMAIL = B.USER_EMAIL
		      AND     A.WRK_LST_ID = C.WRK_LST_ID
		      AND     C.PRJ_ID = D.PRJ_ID
		      AND     A.WRK_DEL_FL = 'N') a )
	</select>

<!-- ******************work_mem_flw**************** -->






<!-- ******************work_push**************** -->




</mapper>