<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="friend">

<!-- *************friend_req**************** -->
	<!-- 친구 요청 -->
	<insert id="firendsRequest" parameterType="friend_reqVo">
		insert into friend_req
		values (req_seq.nextval, #{user_email}, #{req_email}, sysdate, 'FR01', sysdate)
	</insert>
	
	<!-- 친구 요청 리스트 -->
	<select id="friendsRequestList" parameterType="string" resultType="friend_reqVo">
	select a.req_email, b.user_nm
	from
	(select a.req_email
	from friend_req a
	where a.user_email = #{user_email}) a, users b
	where a.req_email = b.user_email
	</select>
	
<!-- *************friends**************** -->
	<!-- 전체 친구 리스트 조회(채팅에서 사용)-->
	<select id="allFriendList" parameterType="string" resultType="chatFriendsVo">
		select frd_email, u.user_nm 
		from friends f , users u
		where f.frd_email = u.user_email
		and f.user_email= #{user_email}
	</select>

	<!-- 채팅방별 친구 리스트 조회 -->
	<select id="roomFriendList">
		
	</select>

	<!-- 친구 등록 -->
	<insert id="insertFriends" parameterType="friendsVo">
		insert into friends
		values (#{user_email}, #{frd_email}, sysdate)
	</insert>
	
	<!-- 친구 페이징 리스트 -->
	<select id="friendPagingList" parameterType="map" resultType="friendsVo">
		<![CDATA[	
		 SELECT *
        FROM
        (SELECT A.FRD_EMAIL, B.USER_NM, ROWNUM RN
        FROM
        (SELECT A.FRD_EMAIL
        FROM FRIENDS A
        WHERE A.USER_EMAIL like '%'||#{user_email}||'%') A, USERS B
        WHERE A.FRD_EMAIL = B.USER_EMAIL)
        where rn >=(#{page}-1)*#{pageSize} + 1 and rn <=#{page}*#{pageSize}
		
		]]>
	</select>
	
	<!-- 친구 페이징 리스트 수 -->
	<select id="friendPagingCnt" parameterType="map" resultType="int">
		select count(*)
		from friends
		where user_email like '%'||#{user_email}||'%'
	</select>
	
	<!-- 일반 사용자가 자신의 친구 목록을  친구의 이메일로 검색 -->
	<select id="friendSearchByEmail" parameterType="map" resultType="friendsVo">
	<![CDATA[
		select *
		from
		(select a.*, rownum rn
		from
		(select a.*
		from friends a
		where frd_email like '%'||#{frd_email}||'%') a)
		where rn >=(#{page}-1)*#{pageSize} + 1 and rn <=#{page}*#{pageSize}
	]]>
	</select>
	<!-- 일반 사용자가 자신의 친구 목록을 친구의 이메일로 검색한 갯수 -->
	<select id="friendSearchByEmailCnt" parameterType="map" resultType="int">
		select count(*)
		from friends
		where frd_email like '%'||#{frd_email}||'%'
	</select>
	
	<!-- 일반 사용자가 자신의 친구를 삭제 삭제 -->
	<delete id="deleteFriends" parameterType="string">
		delete friends where frd_email = #{frd_email}
	</delete>
</mapper>