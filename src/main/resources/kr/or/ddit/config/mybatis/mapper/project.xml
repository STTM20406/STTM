<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="project">

	<!-- **********************project*********************** -->

	<!-- 내가 속한 프로젝트 리스트 조회 -->
	<select id="projectList" parameterType="string" resultType="projectVo">
		SELECT * FROM (SELECT * FROM PROJECT)A INNER JOIN
					  				(SELECT * FROM PROJECT_MEM)B ON
		A.PRJ_ID = B.PRJ_ID AND B.USER_EMAIL = #{user_email} AND A.DEL_FL = 'N'
	</select>

	<!--프로젝트 아이디에 맞는 프로젝트 정보 조회 -->
	<select id="getProject" parameterType="int" resultType="projectVo">
		SELECT * FROM PROJECT WHERE PRJ_ID = #{prj_id}
	</select>

	<!-- 프로젝트 상태에 따라 프로젝트 리스트 조회 -->
	<select id="projectStatusList" parameterType="map" resultType="projectVo">
		SELECT A.PRJ_ID
			 , A.PRJ_NM
			 , A.PRJ_EXP
			 , A.PRJ_AUTH
			 , A.PRJ_START_DT 
			 , A.PRJ_END_DT
			 , A.PRJ_CMP_DT
			 , A.PRJ_ST
			 , A.DEL_FL
			 , B.USER_EMAIL
		FROM ( SELECT A.* FROM (SELECT * FROM PROJECT WHERE PRJ_ST = #{prj_st}) A) A, PROJECT_MEM B
		WHERE  A.PRJ_ID = B.PRJ_ID AND B.USER_EMAIL = #{user_email} AND A.DEL_FL = 'N'
	</select>
	
	
	<!-- 프로젝트 검색 (내가 포함된 프로젝트 중에서) -->
	<select id="projectSearch" parameterType="map" resultType="projectVo">
		SELECT A.PRJ_ID
			 , A.PRJ_NM
			 , A.PRJ_EXP
			 , A.PRJ_AUTH
			 , A.PRJ_START_DT
			 , A.PRJ_END_DT
			 , A.PRJ_CMP_DT
			 , A.PRJ_ST
			 , A.DEL_FL
			 , B.USER_EMAIL
		FROM ( SELECT A.* FROM (SELECT * FROM PROJECT WHERE LOWER(PRJ_NM) LIKE '%'||#{prj_nm}||'%') A) A, PROJECT_MEM B
		WHERE  A.PRJ_ID = B.PRJ_ID AND B.USER_EMAIL = #{user_email} AND A.DEL_FL = 'N'
	</select>


	<!-- 프로젝트 생성 (프로젝트가 생성되는 동시에 프로젝트 멤버에 프로젝트를 생성한 사람 이메일 insert) -->
	<insert id="insertProject" parameterType="projectVo">
		<selectKey resultType="Integer" keyProperty="prj_id" order="BEFORE">
			SELECT PRJ_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO PROJECT (PRJ_ID, PRJ_NM, PRJ_EXP, PRJ_AUTH, PRJ_ST, PRJ_UPDATE, DEL_FL)
		VALUES (#{prj_id}, #{prj_nm}, #{prj_exp}, #{prj_auth}, #{prj_st}, SYSDATE, 'N')
	</insert>
	

	<!-- 프로젝트 상태 업데이트 -->
	<update id="updateProject" parameterType="projectVo">
		UPDATE  PROJECT 
		SET 	PRJ_ST = #{prj_st}
		WHERE   PRJ_ID = #{prj_id}
	</update>
	
	
	<!-- 프로젝트 전체 업데이트 -->
	<update id="updateAllProject" parameterType="projectVo">
		UPDATE PROJECT A SET
					 <if test="prj_nm != null">
					 A.PRJ_NM = #{prj_nm}
					 </if>
                     <if test="prj_exp != null">
					 , A.PRJ_EXP = #{prj_exp}
					 </if>
                     , A.PRJ_AUTH = #{prj_auth}
                     <if test="prj_start_dt != null">
					 , A.PRJ_START_DT = #{prj_start_dt}
					 </if>
					 <if test="prj_end_dt != null">
					 , A.PRJ_END_DT = #{prj_end_dt}
					 </if>
					 <if test="prj_cmp_dt != null">
					 , A.PRJ_CMP_DT = #{prj_cmp_dt}
					 </if>
                     , A.PRJ_ST = #{prj_st}
                     , A.PRJ_UPDATE = SYSDATE
                     , A.DEL_FL = 'N'
		WHERE A.PRJ_ID = #{prj_id}
	</update>


	<!-- 프로젝트 삭제(프로젝트 삭제여부 업데이트) -->
	<update id="deleteProject" parameterType="projectVo">
		UPDATE PROJECT SET DEL_FL = 'Y' WHERE PRJ_ID = #{prj_id}
	</update>

	<!-- 프로젝트 아이디 MAX값 -->
	<select id="maxProjectId" resultType="int">
		select max(prj_id) from project
	</select>
	
	<!-- !!!!!!!!!!1  검색 집합  !!!!!!!!1! -->
	<!-- 업무리스트명 검색 -->
	<select id="searchWorkList" parameterType="map" resultType="projectVo">
		select distinct(p.prj_id), p.prj_nm, p.prj_exp, p.prj_auth,p.prj_start_dt,
				p.prj_end_dt, p.prj_cmp_dt, p.prj_st, p.prj_update, p.del_fl
		from work_list w, project p
		where p.prj_id in(
		    select p.prj_id
		    from project p, project_mem m
		    where p.prj_id = m.prj_id
		    and p.del_fl = 'N'
		    and m.user_email = #{user_email})
		and w.prj_id = p.prj_id
		and w.del_fl = 'N'
		and wrk_lst_nm like '%' || #{wrk_lst_nm} || '%'
	</select>
	
	<!-- 업무명 검색 -->
	<select id="searchWorkNm" parameterType="workVo" resultType="projectVo">
		select p.*
		from project p, project_mem m
		where p.prj_id = m.prj_id
		and p.del_fl='N'
		and m.user_email = #{user_email}
		and m.prj_id in(
		    select distinct(wl.prj_id)
		    from work w, work_list wl
		    where w.wrk_lst_id = wl.wrk_lst_id
		    and w.wrk_del_fl = 'N'
		    and wrk_nm like '%' || #{wrk_nm} || '%')
	</select>

	<!-- *********************project_mem******************** -->

	<!-- 관리자/멤버로 추가 할 프로젝트 멤버 리스트 조회 -->
	<select id="projectMemList" resultType="project_memVo" parameterType="project_memVo">
		SELECT DISTINCT B.PRJ_ID
					  , B.USER_EMAIL
					  , B.PRJ_MEM_LV
					  , B.PRJ_MEM_NIK
					  , B.PRJ_OWN_FL
					  , C.USER_NM FROM
					  ( SELECT * FROM PROJECT_MEM WHERE USER_EMAIL = #{user_email}) A, PROJECT_MEM B, USERS C
		WHERE B.PRJ_ID IN (A.PRJ_ID)
		AND C.USER_EMAIL = B.USER_EMAIL AND B.PRJ_ID = #{prj_id}
	</select>
	
	
	<!-- 프로젝트 멤버로 추가 할 프로젝트 멤버 리스트 조회 -->
	<select id="projectAllMemList" resultType="project_memVo" parameterType="string">
		SELECT DISTINCT B.USER_EMAIL
              , C.USER_NM FROM
              ( SELECT * FROM PROJECT_MEM WHERE USER_EMAIL = #{user_email}) A, PROJECT_MEM B, USERS C
		WHERE B.PRJ_ID IN (A.PRJ_ID)
		AND C.USER_EMAIL = B.USER_EMAIL
	</select>
	
	<!-- 현재 접속한 사용자의 아이디로 프로젝트 멤버 정보 가져오기  -->
	<select id="getProjectMemInfo" resultType="project_memVo" parameterType="project_memVo">
		SELECT DISTINCT A.PRJ_ID
			              	     , A.USER_EMAIL
			              	     , A.PRJ_MEM_LV
			              	     , A.PRJ_MEM_NIK
			              	     , A.PRJ_OWN_FL
			              	     , B.USER_NM 
		FROM          	    ( SELECT * FROM PROJECT_MEM WHERE USER_EMAIL = #{user_email}) A, USERS B
		WHERE           	      A.USER_EMAIL = B.USER_EMAIL AND A.PRJ_ID = #{prj_id}
	</select>
	
	
	<!-- 프로젝트 생성시 멤버 테이블에 동시에 인서트 / 프로젝트 멤버 추가할 때 -->
	<insert id="insertProjectMem" parameterType="project_memVo">
		INSERT INTO
		PROJECT_MEM (PRJ_ID, USER_EMAIL, PRJ_MEM_LV, PRJ_OWN_FL)
		VALUES (#{prj_id}, #{user_email}, #{prj_mem_lv}, #{prj_own_fl})
	</insert>
	
	
	<!-- 프로젝트 멤버 관리자로 추가시 lv0으로 값 업데이트 / 프로젝트 관리자 삭제시 lv1로 값 업데이트 -->
	<update id="updateProjectMem" parameterType="project_memVo">
		UPDATE PROJECT_MEM A SET PRJ_MEM_LV = #{prj_mem_lv} WHERE PRJ_ID = #{prj_id} AND USER_EMAIL = #{user_email}
	</update>
	
	
	<!-- 프로젝트 멤버 삭제할 때 -->
	<delete id="deleteProjectMem" parameterType="project_memVo">
		DELETE FROM PROJECT_MEM WHERE PRJ_ID = #{prj_id} AND USER_EMAIL = #{user_email} AND PRJ_MEM_LV = #{prj_mem_lv}
	</delete>
	

	<!-- 휴면 계정으로 전환하기 위하여 나와 프로젝트 아이디가 같은 멤버 조회 -->
	<select id="getMyProjectMemList" parameterType="string" resultType="project_memVo">
		select distinct b.user_email
             	, c.user_nm from
            	(select * 
				 from project_mem 
				 where user_email = #{user_email}) a, project_mem b, users c
		 where b.prj_id in (a.prj_id)
		 and c.user_email = b.user_email
	</select>
	
	<!-- 사용자가 멤버 탭에서 자신과 같은 프로젝트를 진행하는 멤버의 리스트를 페이징으로 조회 -->
	<select id="projectMemPagingList" parameterType="map" resultType="project_memVo">
		<![CDATA[
		select * from
			(select a.*, rownum rn
		     from
				(select distinct b.user_email
	             			   , c.user_nm from
	            	(select * 
					 from project_mem 
					 where user_email = #{user_email}) a, project_mem b, users c
			 where b.prj_id in (a.prj_id)
			 and c.user_email = b.user_email) a )
		where rn >= (#{page}-1)*#{pageSize} + 1 and rn <= #{page}*#{pageSize}
		]]>
	</select>
	
	<!-- 프로젝트 멤버 전체수 조회 -->
	<select id="projectMemCnt" parameterType="map" resultType="int">
		select count(*)
		from project_mem
		where prj_id like '%'||#{prj_id}||'%'
	</select>
	
	
	<!-- 헤더에 화상회의 친구목록 리스트 -->
	<select id="headerChatFriendList" parameterType="string" resultType="project_memVo">
		select m.prj_id, u.user_nm
		from project_mem m, users u, project p
		where m.user_email = u.user_email
		and p.prj_id = m.prj_id
		and m.prj_id in
		            (select prj_id
		            from project_mem m
		            where m.user_email in #{user_email})
		and p.del_fl = 'N'            
		order by m.prj_id, u.user_nm
	</select>
	
	<!-- *******************project_trnf_hs****************** -->


	<!-- *********************file_attch********************* -->
	
	<!-- public filePagination 공용 파일 링크 보관함!!!! -->
	<select id="publicFilePagination" parameterType="map" resultType="file_attchVo">
		<![CDATA[
			select 
				rownum num, a.file_id, a.prj_id, a.user_email, a.wrk_id, a.original_file_nm, a.db_file_nm, a.file_size, a.file_exts, a.file_dt, a.del_fl, a.FILE_SAVE_FL,a.FILE_COMM_FL, b.wrk_nm, C.USER_NM
			from
				(select a.*, rownum rn 
			from
			(select * 
			from file_attch
			WHERE prj_id = #{prj_id}
			and del_fl='N'
			and file_save_fl ='Y'
			order by file_id desc) a)a, work b, USERS C
			where rn >=(#{page}-1)*#{pageSize}+1 and rn <= #{page}*#{pageSize}
			and b.wrk_id = a.wrk_id
			AND A.USER_EMAIL = C.USER_EMAIL
		]]>
	</select>

	<!-- 해당 프로젝트의 전체 파일수 조회 -->
	<select id="fileCnt" resultType="int">
		select count(*)
		from
			file_attch
		WHERE 
			prj_id = #{prj_id}
        and 
        	del_fl='N'
        and 
        	file_save_fl ='Y'
	</select>
	
	<!-- linkList Pagination -->
	<select id="publicLinkPagination" parameterType="map" resultType="link_attchVo">
   <![CDATA[
      select rownum num, a.link_id, a.prj_id, a.user_email, a.wrk_id, a.attch_url, a.file_link_dt, a.del_fl, b.wrk_nm, c.user_nm
      from
      (select a.*, rownum rn 
      from
      (select * 
      from link_attch
      WHERE prj_id = #{prj_id}
      and del_fl = 'N'
      order by link_id desc) a)a, work b, USERS c
      where rn >=(#{page}-1)*#{pageSize}+1 and rn <= #{page}*#{pageSize}
      and b.wrk_id = a.wrk_id
      and a.user_email = c.user_email
   ]]>
	</select>

	<!-- 해당 프로젝트의 전체 파일수 조회 -->
	<select id="linkCnt" resultType="int">
		select count(*)
		from
		link_attch
		where
		PRJ_ID=#{PRJ_ID}
		and
		del_fl='N'
	</select>
	
	<!-- file, link 상태값 Y로 변경 (삭제 처리) -->
	
	<update id="updateFile" parameterType="int">
		update file_attch
		set
		del_fl ='Y'
		where
		file_id =#{file_id}
	</update>
	
	<update id="updateLink" parameterType="int">
		update link_attch
		set
		del_fl='Y'
		where
		link_id = #{link_id}
	</update>
	
	<!-- public filePagination -->
	
	<insert id="insertFile" parameterType="file_attchVo">
		insert into FILE_ATTCH
		values(
		FILE_SEQ.nextVal,
		#{prj_id},
		#{user_email},
		#{wrk_id},
		#{original_file_nm},
		#{db_file_nm},
		#{file_size},
		#{file_exts},
		sysdate,
		'PU',
		'N')
	</insert>
	
	<!--개인보관함 -->
	<insert id="insertFileIN" parameterType="file_attchVo">
		insert into FILE_ATTCH
		values(
		FILE_SEQ.nextVal,
		#{prj_id},
		#{user_email},
		#{wrk_id},
		#{original_file_nm},
		#{db_file_nm},
		#{file_size},
		#{file_exts},
		sysdate,
		'IN',
		'N')
	</insert>
	
	<select id="selectFile" parameterType="int" resultType="file_attchVo">
	<![CDATA[
	 select a.file_id, a.prj_id, a.user_email, a.wrk_id, a.original_file_nm, a.db_file_nm, a.file_size, a.file_exts, a.file_dt, a.del_fl, a.FILE_SAVE_FL, b.wrk_nm, C.USER_NM
      from
      (select a.*, rownum rn 
      from
      (select * 
      from file_attch
      WHERE file_id = #{file_id}
      and del_fl='N'
      and file_save_fl ='PU'
      order by file_id desc) a)a, work b, USERS C
      where b.wrk_id = a.wrk_id
      AND A.USER_EMAIL = C.USER_EMAIL
      ]]>
	</select>

	<!--개인보관함 -->
	
	<select id="getFile" parameterType="int"
		resultType="file_attchVo">
		select * from FILE_ATTCH
		where FILE_ID = #{file_id}
	</select>
	
	<select id="individualPagination" parameterType="map" resultType="file_attchVo">
	   <![CDATA[
		   	select 
		    rownum num, a.file_id, a.prj_id, a.user_email, a.wrk_id, a.original_file_nm, a.db_file_nm, a.file_size, a.file_exts, a.file_dt, a.del_fl, a.FILE_SAVE_FL,a.FILE_COMM_FL, b.wrk_nm, C.USER_NM
		    from
		    (select a.*, rownum rn 
		    from
		    (select * 
		    from file_attch
		    WHERE del_fl='N'
		    and FILE_COMM_FL ='Y'
		    order by file_id desc) a)a, work b, USERS C
		    where rn>=(#{page}-1)*#{pageSize} + 1 and rn <=#{page}*#{pageSize}
		    and b.wrk_id = a.wrk_id
		    AND A.USER_EMAIL = C.USER_EMAIL
		    and c.USER_EMAIL = #{user_email}
	   ]]>
	</select>
	
	<select id="individualSearchPagination" parameterType="map" resultType="file_attchVo">
	   <![CDATA[
		   	select 
		    rownum num, a.file_id, a.prj_id, a.user_email, a.wrk_id, a.original_file_nm, a.db_file_nm, a.file_size, a.file_exts, a.file_dt, a.del_fl, a.FILE_SAVE_FL,a.FILE_COMM_FL, b.wrk_nm, C.USER_NM
		    from
		    (select a.*, rownum rn 
		    from
		    (select * 
		    from file_attch
		    WHERE original_file_nm like '%'||#{original_file_nm}||'%'
		    and del_fl='N'
		    and FILE_COMM_FL ='Y'
		    order by file_id desc) a)a, work b, USERS C
		     where rn>=(#{page}-1)*#{pageSize} + 1 and rn <=#{page}*#{pageSize}
		    and b.wrk_id = a.wrk_id
		    AND A.USER_EMAIL = C.USER_EMAIL
	   ]]>
	</select>
	
	<select id="individualCnt" parameterType="String" resultType="int">
		select count(*)
	    from
	    (select a.*, rownum rn 
	    from
	    (select * 
	    from file_attch
	    WHERE del_fl='N'
	    and FILE_COMM_FL ='Y'
	    order by file_id desc) a)a, work b, USERS C
	    where b.wrk_id = a.wrk_id
	    AND A.USER_EMAIL = C.USER_EMAIL
	    and c.USER_EMAIL = #{USER_EMAIL}
	</select>
	
	<select id="searchIndividualCnt" parameterType="String" resultType="int">
		select count(*)
	    from
	    (select a.*, rownum rn 
	    from
	    (select * 
	    from file_attch
	    WHERE original_file_nm like '%'||#{original_file_nm}||'%'
	    and del_fl='N'
	    and FILE_COMM_FL ='Y'
	    order by file_id desc) a)a, work b, USERS C
	    where b.wrk_id = a.wrk_id
	    AND A.USER_EMAIL = C.USER_EMAIL
	</select>
	
	<!-- PM, PL 권한 가져오기 -->
	<select id="selectLV" parameterType="project_memVo" resultType="project_memVo">
		SELECT * FROM PROJECT_MEM 
		WHERE 
			USER_EMAIL = #{user_email} 
		AND 
			PRJ_ID = #{prj_id}
	</select>
	
	
	<!-- 개인보관함 -->

	<!-- 해당 프로젝트 파일 리스트 받아오는 쿼리문 -->
	<select id="fileList" parameterType="int"
		resultType="file_attchVo">
		select
		a.file_id
		, a.prj_id
		, a.user_email
		, a.wrk_id
		, a.original_file_nm
		, a.db_file_nm
		, a.file_size
		, a.file_exts
		, a.file_dt
		, a.del_fl
		, b.wrk_nm
		from
		file_attch a, work b
		where
		a.prj_id = #{prj_id}
		and
		a.del_fl = 'N'
		and a.wrk_id = b.wrk_id
	</select>

	<!-- 파일 리스트fileList Pagination -->
	<select id="fPagination" parameterType="map"
		resultType="file_attchVo">
   <![CDATA[
   	  select a.file_id, a.prj_id, a.user_email, a.wrk_id, a.original_file_nm, a.db_file_nm, a.file_size, a.file_exts, a.file_dt, a.del_fl, b.wrk_nm 
      from
      (select a.*, rownum rn 
      from
      (select * 
      from file_attch
      WHERE prj_id = #{prj_id}
      and del_fl='N'
      order by file_id desc) a)a, work b
      where rn >=(#{page}-1)*#{pageSize}+1 and rn <= #{page}*#{pageSize}
      and b.wrk_id = a.wrk_id
   ]]>
	</select>

	
	<!-- 등록할때 fileList Pagination wrk_id필요 -->
	<select id="insertFPagination" parameterType="map"
		resultType="file_attchVo">
   <![CDATA[
   	  select a.file_id, a.prj_id, a.user_email, a.wrk_id, a.original_file_nm, a.db_file_nm, a.file_size, a.file_exts, a.file_dt, a.del_fl, b.wrk_nm 
		from
		(select a.*, rownum rn 
		from
		(select * 
		from file_attch
		WHERE wrk_id = #{wrk_id}
		and del_fl='N'
		order by file_id desc) a)a, work b
		where rn >=(#{page}-1)*#{pageSize}+1 and rn <= #{page}*#{pageSize}
		and b.wrk_id = a.wrk_id
   ]]>
	</select>
	
	<!-- InsertFPagination파일수 조회 -->
	<select id="fCnt" resultType="int">
		select count(*)
		from
		file_attch
		where
		wrk_id = #{wrk_id}
		and
		del_fl='N'
	</select>

	

	<!-- *********************link_attch********************* -->
	<insert id="insertLink" parameterType="link_attchVo">
		insert into LINK_ATTCH
		values(
		LINK_SEQ.nextVal,
		#{prj_id},
		#{user_email},
		#{wrk_id},
		#{attch_url},
		sysdate,
		'N'
		)
	</insert>

	<select id="getLink" parameterType="int"
		resultType="link_attchVo">
		select * from Link_ATTCH
		where LINK_ID = #{link_id}
	</select>

	<!-- 해당 프로젝트의 linkList 받아오는 쿼리문 -->
	<select id="linkList" parameterType="int"
		resultType="link_attchVo">

		select a.LINK_ID, a.PRJ_ID, a.USER_EMAIL, a.WRK_ID, a.ATTCH_URL,
		a.FILE_LINK_DT, a.DEL_FL, b.wrk_nm
		from
		link_attch a, work b
		where
		a.prj_id = #{prj_id}
		and
		a.del_fl ='N'
		and a.wrk_id = b.wrk_id
	</select>

	

	
	
	<!-- InsertLPagination링크수 조회 -->
	<select id="insertLPagination" parameterType="map"	resultType="link_attchVo">
   <![CDATA[
      select a.link_id, a.prj_id, a.user_email, a.wrk_id, a.attch_url, a.file_link_dt, a.del_fl, b.wrk_nm 
      from
      (select a.*, rownum rn 
      from
      (select * 
      from link_attch
      WHERE wrk_id = #{wrk_id}
      and del_fl = 'N'
      order by link_id desc) a)a, work b
      where rn >=(#{page}-1)*#{pageSize}+1 and rn <= #{page}*#{pageSize}
      and b.wrk_id = a.wrk_id
   ]]>
	</select>
	
	<!-- insert 파일수 조회 -->
	<select id="lCnt" resultType="int">
		select count(*)
		from
		link_attch
		where
		wrk_id=#{wrk_id}
		and
		del_fl='N'
	</select>
	
	<!-- 다운로드 이용 내역 -->
	<select id="historyPagination" parameterType="map" resultType="file_dw_hisVo">
	 <![CDATA[
		 select rownum num, a.DOWN_ID, a.PRJ_ID, a.USER_EMAIL, a.FILE_ID, a.DOWN_DATE, b.wrk_nm, c.ORIGINAL_FILE_NM, d.user_nm
		from
		(select a.*, rownum rn 
		from
		(select * from FILE_DW_HIS
		where prj_id = #{prj_id}
		order by down_id desc) a)a, work b, FILE_ATTCH c, users d
        where rn >=(#{page}-1)*#{pageSize}+1 and rn <= #{page}*#{pageSize}
		and a.file_id = c.file_id
		and b.wrk_id = c.wrk_id
        and a.user_email=d.user_email
	]]>
	</select>
	
	<select id="historyCnt" parameterType="int" resultType="int">
		select count(*)
		from
			FILE_DW_HIS
		where
			prj_id = #{prj_id}
	</select>	




	
	<!-- 개인 보관함!xml -->
	<!-- 내 보관함에있는 파일 목록 페이지네이션 -->
	<select id="individualBox" parameterType="map" resultType="file_attchVo">
	  <![CDATA[
	  select rownum num, a.file_id, a.prj_id, a.user_email, a.wrk_id, a.original_file_nm, a.db_file_nm, a.file_size, a.file_exts, a.file_dt, a.del_fl,a.FILE_SAVE_FL, b.wrk_nm 
      from
      (select a.*, rownum rn 
      from
      (select * 
      from file_attch
      WHERE prj_id = #{prj_id}
      and user_email = #{user_email}
      and del_fl='N'
      and file_save_fl = 'IN'
      order by file_id desc) a)a, work b
      where rn >=(#{page}-1)*#{pageSize}+1 and rn <= #{page}*#{pageSize}
      and a.WRK_ID = b.WRK_ID
      ]]>
	</select>
	
	
	
	
	
	<!-- *********************minutes************************ -->

	<select id="minutesList" parameterType="int" resultType="minutesVo">
		select A.*, B.user_nm from minutes A, users B
		where prj_id=#{prj_id}
		and A.user_email = B.user_email
		order by A.prj_id asc
	</select>

	<select id="minutesPagination" parameterType="map" resultType="minutesVo">
		<![CDATA[
		select rownum num, a.mnu_id, a.prj_id, a.user_email, a.subject, a.special, a.write_date, a.del_fl, a.user_nm 
		from
		(select a.*, rownum rn 
		from
		(select A.*, B.user_nm from minutes A, users B
		where prj_id = #{prj_id}
		and A.user_email = B.user_email
		and A.del_fl ='N'
		order by A.mnu_id desc) a)a
		where rn >=(#{page}-1)*#{pageSize}+1 and rn <= #{page}*#{pageSize}
	 	]]>
	</select>
	
	<select id="minutesCnt" parameterType="int" resultType="int">
	 select count(*)
		from
		minutes
		where
		prj_id =#{prj_id}
		and
		del_fl='N'
	</select>
	
	<select id="minutesDetail" parameterType="int" resultType="minutesVo">
		select A.*, B.user_nm from minutes A, users B
		where mnu_id=#{mnu_id}
		and A.user_email = B.user_email
		and A.del_fl = 'N'
	</select>
	
	<!-- 검색 -->
	<select id="searchPagination" parameterType="map" resultType="minutesVo">
		<![CDATA[
		select rownum num, a.mnu_id, a.prj_id, a.user_email, a.subject, a.special, a.write_date, a.del_fl, a.user_nm 
	    from
	    (select a.*, rownum rn 
	    from
	    (select A.*, B.user_nm from minutes A, users B
	    where B.user_nm like '%'||#{user_nm}||'%'
	    and A.prj_id=#{prj_id}
	    and A.del_fl ='N'
	    and A.user_email = B.user_email
	    order by A.prj_id asc) a)a
	    where rn >=(#{page}-1)*#{pageSize}+1 and rn <= #{page}*#{pageSize}
	    ]]>
	</select>
	
	<select id="searchCnt" parameterType="String" resultType="int">
		select count(*)
		from  
	    (select A.*, B.user_nm from minutes A, users B
	    where B.user_nm like '%'||#{user_nm}||'%'
	    and A.del_fl ='N'
	    and A.user_email = B.user_email)
	</select>
	
	<select id="attenderList" parameterType="int" resultType="minutes_memVo">
		select A.*, B.user_nm from MINUTES_MEM A, users B
		where mnu_id = #{mnu_id}
        and A.user_email=B.user_email
	</select>
	
	<update id="upMinutes" parameterType="int">
		update minutes set
			del_fl = 'Y'
		where
			mnu_id = #{mnu_id}
	</update>
	
	<select id="memberList" parameterType="String" resultType="userVo">
       SELECT DISTINCT B.USER_EMAIL
              , C.USER_NM FROM
              ( SELECT * FROM PROJECT_MEM WHERE USER_EMAIL = #{USER_EMAIL}) A, PROJECT_MEM B, USERS C
                WHERE B.PRJ_ID IN (A.PRJ_ID)
                AND C.USER_EMAIL = B.USER_EMAIL
   	</select>
   	
	<select id="recentMinutes" resultType="minutesVo">
       select* from 
	   (select * from
	   minutes
	   order by mnu_id desc)
	   where rownum = 1
   	</select>
	
	<!--참석자 멤버 등록 -->
	<insert id="insertAttender" parameterType="minutes_memVo">
		insert into MINUTES_MEM values(MNU_MEM_SEQ.nextVal, #{mnu_id},#{user_email})
	</insert>
	
	
	<!-- 나중에  email값주고 이름만 받아오는 쿼리로 바꿔야함!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
	<select id="whoAreYou" parameterType="String" resultType="userVo">
		select 
			user_nm, user_email
		from 
			users
	    where 
	    	user_email = #{user_email}
	</select>
	
	<insert id="insertMinutes" parameterType="minutesVo">
		insert into minutes 
		values(MNU_SEQ.nextVal,#{prj_id},#{user_email},#{subject},#{special},sysdate,'N')
	</insert>
	
	<update id="updateMinutes" parameterType="minutesVo" >
		update minutes 
			set 
			    subject=#{subject},
			    special=#{special}
			where
    			mnu_id=#{mnu_id}
	</update>
	
	<!-- *********************meeting************************ -->
</mapper>